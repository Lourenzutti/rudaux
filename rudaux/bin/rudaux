#!/usr/bin/python3

from argparse import ArgumentParser
from rudaux import commands
import pendulum as plm
import os, sys

#print begin stamp for now while still debugging (useful for reading logs)
sys.stderr.write('\n\n\n')
sys.stderr.write('---------------------------------\n')
sys.stderr.write('-----------Rudaux----------------\n')
sys.stderr.write('---------------------------------\n')
sys.stderr.write('DateTime: ' + str(plm.now().in_timezone('America/Vancouver')) + ' Vancouver Time\n')
sys.stderr.write('Command: ' + str(sys.argv)+'\n')

parser = ArgumentParser(
  description='Manage a Canvas / Jupyterhub / NbGrader course.'
)

subparsers = parser.add_subparsers(
  title='Subcommands', dest="subparser", help='Commands that rudaux can process.'
)

#------------------------------------
#          Snapshot 
#------------------------------------

snap_parser = subparsers.add_parser('snapshot', help='Take a snapshot of submissions past the assignment due date.')
snap_parser.set_defaults(func=commands.snapshot)
snap_parser.add_argument(
  '--dir',
  dest='directory',
  action='store',
  default=os.getcwd(),
  help="The directory containing the rudaux configuration file."
)

#------------------------------------
#           List 
#------------------------------------
list_parser = subparsers.add_parser('list', help='Print a list of assignments, students, etc')
list_parser.set_defaults(func=commands.print_list)
list_parser.add_argument(
  '--dir',
  dest='directory',
  action='store',
  default=os.getcwd(),
  help="The directory containing the rudaux configuration file."
)
list_parser.add_argument(
  '--assignments',
  '-a',
  dest='assignments',
  action='store_true',
  default=False,
  help='Print assignments'
)
list_parser.add_argument(
  '--students',
  '-s',
  dest='students',
  action='store_true',
  default=False,
  help='Print students'
)
list_parser.add_argument(
  '--instructors',
  '-i',
  dest='instructors',
  action='store_true',
  default=False,
  help='Print instructors'
)
list_parser.add_argument(
  '--tas',
  '-t',
  dest='tas',
  action='store_true',
  default=False,
  help='Print teaching assistants'
)

#---------------------------------------------
#           Extensions for Late Registrants
#---------------------------------------------

latereg_parser = subparsers.add_parser('extend_lateregs', help='Create due date overrides for late registrants')
latereg_parser.set_defaults(func=commands.apply_latereg_extensions)
latereg_parser.add_argument(
  '--dir',
  dest='directory',
  action='store',
  default=os.getcwd(),
  help="The directory containing the rudaux configuration file."
)


# Parse the arguments!
args = parser.parse_args()
if args.subparser is not None:
  args.func(args)
else:
  # Otherwise, no subcommand was called, so raise help
  args = parser.parse_known_args(['-h'])
