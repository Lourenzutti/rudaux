
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>rudaux.course &#8212; Rudaux  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for rudaux.course</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Manage an entire course at once.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pendulum</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="c1"># For parsing assignments from CSV</span>
<span class="c1"># import pandas as pd</span>
<span class="c1"># For progress bar</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">weir</span> <span class="k">import</span> <span class="n">zfs</span>
<span class="kn">from</span> <span class="nn">git</span> <span class="k">import</span> <span class="n">Repo</span>
<span class="c1"># For setting up autograding</span>
<span class="kn">from</span> <span class="nn">crontab</span> <span class="k">import</span> <span class="n">CronTab</span>
<span class="kn">from</span> <span class="nn">terminaltables</span> <span class="k">import</span> <span class="n">AsciiTable</span>
<span class="c1"># For decoding base64-encoded files from GitHub API</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="k">import</span> <span class="n">b64decode</span>
<span class="c1"># for urlencoding query strings to persist through user-redirect</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span> <span class="k">as</span> <span class="nn">urlparse</span>

<span class="c1"># Bring in nbgrader API</span>
<span class="kn">from</span> <span class="nn">nbgrader.apps</span> <span class="k">import</span> <span class="n">NbGraderAPI</span>
<span class="c1"># Don&#39;t reinvent the wheel! Use nbgrader&#39;s method for finding notebooks</span>
<span class="kn">from</span> <span class="nn">nbgrader</span> <span class="k">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">nbutils</span>

<span class="c1"># Bring in Traitlet Configuration methods</span>
<span class="kn">from</span> <span class="nn">traitlets.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">traitlets.config.application</span> <span class="k">import</span> <span class="n">Application</span>

<span class="c1"># Import my rudaux utils</span>
<span class="kn">import</span> <span class="nn">rudaux</span>
<span class="kn">from</span> <span class="nn">rudaux</span> <span class="k">import</span> <span class="n">utils</span>

<span class="c1">#* All internal _methods() return an object</span>

<span class="c1">#* All external  methods() return self (are chainable), and mutate object state</span>
<span class="c1">#* or initiate other side-effects</span>

<span class="c1"># Must be instantiated with a course ID</span>
<div class="viewcode-block" id="Course"><a class="viewcode-back" href="../../rudaux.html#rudaux.course.Course">[docs]</a><span class="k">class</span> <span class="nc">Course</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Course object for manipulating an entire Canvas/JupyterHub/nbgrader course</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">course_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cron</span><span class="o">=</span><span class="kc">False</span>
  <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param course_dir: The directory your course. If none, defaults to current working directory. </span>
<span class="sd">    :type course_dir: str</span>

<span class="sd">    :returns: A Course object for performing operations on an entire course at once.</span>
<span class="sd">    :rtype: Course</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#     Working Directory &amp; Git Sync      #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1"># Set up the working directory. If no course_dir has been specified, then it</span>
    <span class="c1"># is assumed that this is the course directory. </span>
    <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">course_dir</span> <span class="k">if</span> <span class="n">course_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    
    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>

    <span class="c1"># Before we do ANYTHING, make sure our working directory is clean with no</span>
    <span class="c1"># untracked files! Unless we&#39;re running a cron job, in which case we don&#39;t</span>
    <span class="c1"># want to fail for an unexpected reason.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">()</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">untracked_files</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cron</span><span class="p">):</span>
      <span class="n">continue_with_dirty</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Your repository is currently in a dirty state (modifications or</span>
<span class="sd">        untracked changes are present). We strongly suggest that you resolve</span>
<span class="sd">        these before proceeding. Continue? [y/n]:&quot;&quot;&quot;</span>
      <span class="p">)</span>
      <span class="c1"># if they didn&#39;t say no, exit</span>
      <span class="k">if</span> <span class="n">continue_with_dirty</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Exiting...&quot;</span><span class="p">)</span>

    <span class="c1"># PRINT BANNER</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">AsciiTable</span><span class="p">([[</span><span class="s1">&#39;Initializing Course and Pulling Instructors Repo&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="c1"># pull the latest copy of the repo</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">pull_repo</span><span class="p">(</span><span class="n">repo_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>

    <span class="c1"># Make sure we&#39;re running our nbgrader commands within our instructors repo.</span>
    <span class="c1"># this will contain our gradebook database, our source directory, and other</span>
    <span class="c1"># things.</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">CourseDirectory</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#              Load Config              #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1"># Check for an nbgrader config file...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;nbgrader_config.py&#39;</span><span class="p">)):</span>
      <span class="c1"># if there isn&#39;t one, make sure there&#39;s at least a rudaux config file</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;rudaux_config.py&#39;</span><span class="p">)):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          You do not have nbgrader_config.py or rudaux_config.py in your current</span>
<span class="sd">          directory. We need at least one of these to set up your course</span>
<span class="sd">          parameters! You can specify a directory with the course_dir argument</span>
<span class="sd">          if you wish.</span>
<span class="sd">          &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># use the traitlets Application class directly to load nbgrader config file.</span>
    <span class="c1"># reference:</span>
    <span class="c1"># https://github.com/jupyter/nbgrader/blob/41f52873c690af716c796a6003d861e493d45fea/nbgrader/server_extensions/validate_assignment/handlers.py#L35-L37</span>

    <span class="c1"># ._load_config_files() returns a generator, so if the config is missing,</span>
    <span class="c1"># the generator will act similarly to an empty array</span>

    <span class="c1"># load rudaux_config if it exists, otherwise just bring in nbgrader_config.</span>
    <span class="k">for</span> <span class="n">rudaux_config</span> <span class="ow">in</span> <span class="n">Application</span><span class="o">.</span><span class="n">_load_config_files</span><span class="p">(</span><span class="s1">&#39;rudaux_config&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">):</span>
      <span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rudaux_config</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">nbgrader_config</span> <span class="ow">in</span> <span class="n">Application</span><span class="o">.</span><span class="n">_load_config_files</span><span class="p">(</span><span class="s1">&#39;nbgrader_config&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">):</span>
      <span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">nbgrader_config</span><span class="p">)</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#           Set Config Params           #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1">## NBGRADER PARAMS</span>

    <span class="c1"># If the user set the exchange, perform home user expansion if necessary</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Exchange&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># perform home user expansion. Should not throw an error, but may</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="c1"># expand home user in-place</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Exchange&#39;</span><span class="p">][</span><span class="s1">&#39;root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;Exchange&#39;</span><span class="p">][</span><span class="s1">&#39;root&#39;</span><span class="p">])</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1">## CANVAS PARAMS</span>

    <span class="c1"># Before we continue, make sure we have all of the necessary parameters.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Canvas&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;course_id&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">canvas_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Canvas&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;canvas_url&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">external_tool_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Canvas&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;external_tool_name&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">external_tool_level</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Canvas&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;external_tool_level&#39;</span><span class="p">)</span>
    <span class="c1"># The canvas url should have no trailing slash</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">canvas_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_url</span><span class="p">)</span>

    <span class="c1">## GITHUB PARAMS</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stu_repo_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GitHub&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stu_repo_url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assignment_release_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GitHub&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignment_release_path&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ins_repo_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GitHub&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ins_repo_url&#39;</span><span class="p">)</span>
    <span class="c1"># subpath not currently supported</span>
    <span class="c1"># self.ins_dir_subpath = config.get(&#39;GitHub&#39;).get(&#39;ins_dir_subpath&#39;)</span>
      
    <span class="c1">## JUPYTERHUB PARAMS</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hub_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JupyterHub&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hub_url&#39;</span><span class="p">)</span>
    <span class="c1"># The hub url should have no trailing slash</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hub_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_url</span><span class="p">)</span>
    <span class="c1"># Get Storage directory &amp; type</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JupyterHub&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">zfs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JupyterHub&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zfs&#39;</span><span class="p">)</span> <span class="c1"># default is false!</span>
    <span class="c1"># Note hub_prefix, not base_url, to avoid any ambiguity</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hub_prefix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JupyterHub&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_url&#39;</span><span class="p">)</span>
    <span class="c1"># If prefix was set, make sure it has no trailing slash, but a preceding</span>
    <span class="c1"># slash</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">hub_prefix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_prefix</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_prefix</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hub_prefix</span> <span class="o">=</span> <span class="n">fr</span><span class="s2">&quot;/</span><span class="si">{self.hub_prefix}</span><span class="s2">&quot;</span>

    <span class="c1">## COURSE PARAMS</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">grading_image</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grading_image&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmp_dir&#39;</span><span class="p">)</span>
    <span class="n">assignment_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignments&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">course_timezone</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timezone&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">system_timezone</span> <span class="o">=</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">name</span>

    <span class="c1">## Repurpose the rest of the params for later batches</span>
    <span class="c1">## (Hang onto them in case we need something)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_full_config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#        Validate URLs (Slightly)       #</span>
    <span class="c1">#=======================================#</span>

    <span class="n">urls</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;JupyterHub.hub_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_url</span><span class="p">,</span>
      <span class="s1">&#39;Canvas.canvas_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_url</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">urls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^https{0,1}&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
          <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          You must specify the scheme (e.g. https://) for all URLs.</span>
<span class="s2">          You are missing the scheme in &quot;</span><span class="si">{key}</span><span class="s2">&quot;:</span>
<span class="s2">          </span><span class="si">{value}</span><span class="s2"></span>
<span class="s2">          &quot;&quot;&quot;</span>
        <span class="p">)</span>
      <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.git$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
          <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          Please do not use .git-appended URLs. </span>
<span class="s2">          You have used a .git url in &quot;</span><span class="si">{key}</span><span class="s2">&quot;:</span>
<span class="s2">          </span><span class="si">{value}</span><span class="s2"></span>
<span class="s2">          &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#       Check For Required Params       #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1"># Finally, before we continue, make sure all of our required parameters were</span>
    <span class="c1"># specified in the config file(s)</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;Canvas.course_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
      <span class="s2">&quot;Canvas.canvas_url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_url</span><span class="p">,</span>
      <span class="s2">&quot;GitHub.stu_repo_url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stu_repo_url</span><span class="p">,</span>
      <span class="s2">&quot;GitHub.ins_repo_url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ins_repo_url</span><span class="p">,</span>
      <span class="s2">&quot;JupyterHub.hub_url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_url</span><span class="p">,</span>
      <span class="s2">&quot;Course.assignments&quot;</span><span class="p">:</span> <span class="n">assignment_list</span>
    <span class="p">}</span>
    
    <span class="c1"># If any are none...</span>
    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">required_params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="c1"># Figure out which ones are none and let the user know.</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">required_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;    </span><span class="se">\&quot;</span><span class="si">{key}</span><span class="se">\&quot;</span><span class="s2"> is missing.&quot;</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Please make sure you have specified all required parameters in your config file.&#39;</span><span class="p">)</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#       Check For Optional Params       #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1"># Now look for all of our optional parameters. If any are missing, let the</span>
    <span class="c1"># user know we&#39;ll be using the default. </span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;assignment_release_path&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_release_path</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s1">&#39;materials&#39;</span><span class="p">,</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;GitHub.assignment_release_path&quot;</span>
      <span class="p">},</span>
      <span class="c1"># &quot;assignment_source_path&quot;: {</span>
      <span class="c1">#   &quot;value&quot;: self.assignment_source_path,</span>
      <span class="c1">#   &quot;default&quot;: &quot;source&quot;,</span>
      <span class="c1">#   &quot;config_name&quot;: &quot;c.GitHub.assignment_source_path&quot;</span>
      <span class="c1"># },</span>
      <span class="s2">&quot;hub_prefix&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_prefix</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;JupyterHub.base_url&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;zfs&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zfs</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;JupyterHub.zfs&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;course_timezone&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_timezone</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s1">&#39;US/Pacific&#39;</span><span class="p">,</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Course.timezone&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;grading_image&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grading_image</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s1">&#39;ubcdsci/r-dsci-grading&#39;</span><span class="p">,</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Course.grading_image&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;tmp_dir&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="s1">&#39;tmp&#39;</span><span class="p">),</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Course.tmp_dir&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;external_tool_name&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tool_name</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s1">&#39;Jupyter&#39;</span><span class="p">,</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Canvas.external_tool_name&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;external_tool_level&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tool_level</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s1">&#39;course&#39;</span><span class="p">,</span>
        <span class="s2">&quot;config_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Canvas.external_tool_level&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">optional_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;    </span><span class="se">\&quot;</span><span class="s2">{param.get(&#39;config_name&#39;)}</span><span class="se">\&quot;</span><span class="s2"> is missing, using default parameter of </span><span class="se">\&quot;</span><span class="s2">{getattr(self, key)}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Make sure no preceding or trailing slashes in assignment release path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assignment_release_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_release_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assignment_release_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_release_path</span><span class="p">)</span>

    <span class="c1"># Since we are using the student repo URL for the Launch URLs </span>
    <span class="c1"># (i.e. telling nbgitpuller where to find the notebook), </span>
    <span class="c1"># if the user provided an SSH url, we need the https version as well.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stu_launch_url</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generate_git_urls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stu_repo_url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plain_https&#39;</span><span class="p">)</span>

    <span class="c1">#! this is cheating a bit, but we can get the repo name this way</span>
    <span class="c1">#! Fix me in the future</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ins_repo_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">generate_git_urls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ins_repo_url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plain_https&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stu_repo_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stu_launch_url</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#           Set Canvas Token            #</span>
    <span class="c1">#=======================================#</span>

    <span class="n">canvas_token_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Canvas&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token_name&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">canvas_token_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Searching for default Canvas token, CANVAS_TOKEN...&quot;</span><span class="p">)</span>
      <span class="n">canvas_token_name</span> <span class="o">=</span> <span class="s1">&#39;CANVAS_TOKEN&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">canvas_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_token</span><span class="p">(</span><span class="n">canvas_token_name</span><span class="p">)</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#        Finalize Setting Params        #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1"># set up the nbgrader api with our merged config files</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nb_api</span> <span class="o">=</span> <span class="n">NbGraderAPI</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># assign init params to object</span>
    <span class="c1"># self.canvas_token = self._get_token(canvas_token_name)</span>
    <span class="c1"># self.course = self._get_course()</span>

    <span class="c1"># Set crontab</span>
    <span class="c1"># self.cron = CronTab(user=True)</span>
    <span class="c1"># We need to use the system crontab because we&#39;ll be making ZFS snapshots</span>
    <span class="c1"># which requires elevated permissions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cron</span> <span class="o">=</span> <span class="n">CronTab</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#        Instantiate Assignments        #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1"># Subclass assignment for this course:</span>
    <span class="k">class</span> <span class="nc">CourseAssignment</span><span class="p">(</span><span class="n">rudaux</span><span class="o">.</span><span class="n">Assignment</span><span class="p">):</span>
      <span class="n">course</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">instantiated_assignments</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_assignment</span> <span class="ow">in</span> <span class="n">assignment_list</span><span class="p">:</span>
      <span class="n">assignment</span> <span class="o">=</span> <span class="n">CourseAssignment</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
        <span class="n">duedate</span><span class="o">=</span><span class="n">_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duedate&#39;</span><span class="p">),</span>
        <span class="n">duetime</span><span class="o">=</span><span class="n">_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duetime&#39;</span><span class="p">,</span> <span class="s1">&#39;23:59:59&#39;</span><span class="p">),</span> <span class="c1"># default is 1 sec to midnight</span>
        <span class="n">points</span><span class="o">=</span><span class="n">_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># default is zero points</span>
        <span class="n">manual</span><span class="o">=</span><span class="n">_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="c1"># default is no manual grading</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span>
      <span class="p">)</span>
      <span class="n">instantiated_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span> <span class="o">=</span> <span class="n">instantiated_assignments</span>

<span class="c1">#------------------ End Constructor ------------------#</span>

  <span class="c1"># Get the canvas token from the environment</span>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_get_token</span><span class="p">(</span><span class="n">token_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get an API token from an environment variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">token_name</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">token</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Could not find the environment variable </span><span class="se">\&quot;</span><span class="si">{token_name}</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>
      <span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="Course.get_external_tool_id"><a class="viewcode-back" href="../../rudaux.html#rudaux.course.Course.get_external_tool_id">[docs]</a>  <span class="k">def</span> <span class="nf">get_external_tool_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Course&#39;</span><span class="p">:</span> 
    <span class="sd">&quot;&quot;&quot;Find the ID of the external tool created in Canvas that represents your JupyterHub server.&quot;&quot;&quot;</span>

    <span class="c1"># PRINT BANNER</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Finding External Tool in Canvas&#39;</span><span class="p">))</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
      <span class="n">url</span><span class="o">=</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_url</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;/api/v1/</span><span class="si">{self.external_tool_level}</span><span class="s2">s/</span><span class="si">{self.course_id}</span><span class="s2">/external_tools&quot;</span>
      <span class="p">),</span>
      <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;Bearer </span><span class="si">{self.canvas_token}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json+canvas-string-ids&quot;</span>
      <span class="p">},</span>
      <span class="n">params</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;search_term&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tool_name</span>
      <span class="p">}</span>
    <span class="p">)</span>
    <span class="c1"># first make sure we didn&#39;t silently error</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="n">external_tools</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="n">external_tool</span> <span class="o">=</span> <span class="n">external_tools</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">external_tools</span><span class="p">:</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
        <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        No external tools found with the name </span><span class="si">{self.external_tool_name}</span><span class="s2">&quot;</span>
<span class="s2">        at the </span><span class="si">{self.external_tool_level}</span><span class="s2"> level. </span>
<span class="s2">        Exiting...</span>
<span class="s2">        &quot;&quot;&quot;</span>
      <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_tools</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span>
        <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        More than one external tool found, using the one named &quot;{external_tool.get(&#39;name&#39;)}&quot;.</span>
<span class="s2">        Description: &quot;{external_tool.get(&#39;description&#39;)}&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span>
      <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">external_tool_id</span> <span class="o">=</span> <span class="n">external_tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Course.get_students_from_canvas"><a class="viewcode-back" href="../../rudaux.html#rudaux.course.Course.get_students_from_canvas">[docs]</a>  <span class="k">def</span> <span class="nf">get_students_from_canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Course&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the student list for a course. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># PRINT BANNER</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Getting Student List From Canvas&#39;</span><span class="p">))</span>

    <span class="c1"># List all of the students in the course</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
      <span class="n">url</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.canvas_url}</span><span class="s2">/api/v1/courses/</span><span class="si">{self.course_id}</span><span class="s2">/users&quot;</span><span class="p">,</span>
      <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;Bearer </span><span class="si">{self.canvas_token}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json+canvas-string-ids&quot;</span>
      <span class="p">},</span>
      <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;enrollment_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;student&quot;</span><span class="p">]</span>
      <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Make sure our request didn&#39;t fail silently</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="c1"># pull out the response JSON</span>
    <span class="n">students</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">students</span> <span class="o">=</span> <span class="n">students</span>
    <span class="k">return</span> <span class="bp">self</span></div>

  <span class="c1"># def get_assignments_from_canvas(self):</span>
  <span class="c1">#   &quot;&quot;&quot;</span>
  <span class="c1">#   Get all assignments for a course.</span>
  <span class="c1">#   &quot;&quot;&quot;</span>
  <span class="c1">#   resp = requests.get(</span>
  <span class="c1">#     url=f&quot;{self.canvas_url}/api/v1/courses/{self.course_id}/assignments&quot;,</span>
  <span class="c1">#     headers={</span>
  <span class="c1">#       &quot;Authorization&quot;: f&quot;Bearer {self.canvas_token}&quot;,</span>
  <span class="c1">#       &quot;Accept&quot;: &quot;application/json+canvas-string-ids&quot;</span>
  <span class="c1">#     }</span>
  <span class="c1">#   )</span>

  <span class="c1">#   # Make sure our request didn&#39;t fail silently</span>
  <span class="c1">#   resp.raise_for_status()</span>

  <span class="c1">#   # pull out the response JSON</span>
  <span class="c1">#   canvas_assignments = resp.json()</span>

  <span class="c1">#   # Create an assignment object from each assignment</span>
  <span class="c1">#   # `canvas_assignments` is a list of objects (dicts) so `**` is like the object spread operator (`...` in JS)</span>
  <span class="c1">#   assignments = map(</span>
  <span class="c1">#     lambda assignment: Assignment(**assignment),</span>
  <span class="c1">#     canvas_assignments</span>
  <span class="c1">#   )</span>
  <span class="c1">#   self.assignments = assignments</span>

  <span class="c1">#   return self</span>

<div class="viewcode-block" id="Course.sync_nbgrader"><a class="viewcode-back" href="../../rudaux.html#rudaux.course.Course.sync_nbgrader">[docs]</a>  <span class="k">def</span> <span class="nf">sync_nbgrader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enter information into the nbgrader gradebook database about the assignments and the students.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># PRINT BANNER</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Syncing With NBgrader&#39;</span><span class="p">))</span>

    <span class="c1"># nbgrader API docs: </span>
    <span class="c1"># https://nbgrader.readthedocs.io/en/stable/api/gradebook.html#nbgrader.api.Gradebook</span>
    <span class="n">gradebook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_api</span><span class="o">.</span><span class="n">gradebook</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="c1">###############################</span>
      <span class="c1">#     Update Student List     #</span>
      <span class="c1">###############################</span>

      <span class="n">nb_student_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_student</span><span class="p">:</span> <span class="n">_student</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gradebook</span><span class="o">.</span><span class="n">students</span><span class="p">))</span>
      <span class="c1"># Don&#39;t use .get(&#39;id&#39;) here, because we want this to fail loudly</span>
      <span class="n">canvas_student_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_student</span><span class="p">:</span> <span class="n">_student</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">students</span><span class="p">))</span>

      <span class="c1"># First find the students that are in canvas but NOT in nbgrader</span>
      <span class="n">students_missing_from_nbgrader</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">canvas_student_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">nb_student_ids</span><span class="p">))</span>
      <span class="c1"># Then find the students that are in nbgrader but NOT in Canvas (this</span>
      <span class="c1"># could only happen if they had withdrawn from the course)</span>
      <span class="n">students_withdrawn_from_course</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nb_student_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">canvas_student_ids</span><span class="p">))</span>

      <span class="n">students_no_change</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">canvas_student_ids</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nb_student_ids</span><span class="p">))</span>

      <span class="n">student_header</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Student ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="s2">&quot;Action&quot;</span><span class="p">]</span>
      <span class="p">]</span>

      <span class="n">student_status</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">if</span> <span class="n">students_missing_from_nbgrader</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">student_id</span> <span class="ow">in</span> <span class="n">students_missing_from_nbgrader</span><span class="p">:</span>
          <span class="n">student_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
              <span class="n">student_id</span><span class="p">,</span>
              <span class="s2">&quot;missing from nbgrader&quot;</span><span class="p">,</span>
              <span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.DARKCYAN}</span><span class="s2">added to nbgrader</span><span class="si">{utils.color.END}</span><span class="s2">&quot;</span>
            <span class="p">]</span>
          <span class="p">)</span>
          <span class="n">gradebook</span><span class="o">.</span><span class="n">add_student</span><span class="p">(</span><span class="n">student_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">students_withdrawn_from_course</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">student_id</span> <span class="ow">in</span> <span class="n">students_withdrawn_from_course</span><span class="p">:</span>
          <span class="n">gradebook</span><span class="o">.</span><span class="n">remove_student</span><span class="p">(</span><span class="n">student_id</span><span class="p">)</span>
          <span class="n">student_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
              <span class="n">student_id</span><span class="p">,</span>
              <span class="s2">&quot;missing from canvas&quot;</span><span class="p">,</span>
              <span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.YELLOW}</span><span class="s2">removed from nbgrader</span><span class="si">{utils.color.END}</span><span class="s2">&quot;</span>
            <span class="p">]</span>
          <span class="p">)</span>
      <span class="k">if</span> <span class="n">students_no_change</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">student_id</span> <span class="ow">in</span> <span class="n">students_no_change</span><span class="p">:</span>
          <span class="n">student_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
              <span class="n">student_id</span><span class="p">,</span> 
              <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u2713</span><span class="s1">&#39;</span><span class="p">,</span> <span class="c1"># unicode checkmark</span>
              <span class="s2">&quot;none&quot;</span>
            <span class="p">]</span>
          <span class="p">)</span>

      <span class="c1"># sort the status list</span>
      <span class="n">student_status</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">student_status</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 

      <span class="n">table</span> <span class="o">=</span> <span class="n">AsciiTable</span><span class="p">(</span><span class="n">student_header</span> <span class="o">+</span> <span class="n">student_status</span><span class="p">)</span>
      <span class="n">table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Students&#39;</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

      <span class="c1">##################################</span>
      <span class="c1">#     Update Assignment List     #</span>
      <span class="c1">##################################</span>

      <span class="n">nb_assignments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_assignment</span><span class="p">:</span> <span class="n">_assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">gradebook</span><span class="o">.</span><span class="n">assignments</span><span class="p">))</span>
      <span class="n">config_assignments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_assignment</span><span class="p">:</span> <span class="n">_assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">))</span>

      <span class="n">assignments_missing_from_nbgrader</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">config_assignments</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">nb_assignments</span><span class="p">))</span>
      <span class="n">assignments_withdrawn_from_config</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nb_assignments</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">config_assignments</span><span class="p">))</span>

      <span class="n">assignments_no_change</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config_assignments</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nb_assignments</span><span class="p">))</span>

      <span class="n">assignment_header</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Assignment&quot;</span><span class="p">,</span> <span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="s2">&quot;Action&quot;</span><span class="p">]</span>
      <span class="p">]</span>

      <span class="n">assignment_status</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">if</span> <span class="n">assignments_missing_from_nbgrader</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">assignment_name</span> <span class="ow">in</span> <span class="n">assignments_missing_from_nbgrader</span><span class="p">:</span>
          <span class="n">gradebook</span><span class="o">.</span><span class="n">add_assignment</span><span class="p">(</span><span class="n">assignment_name</span><span class="p">)</span>
          <span class="n">assignment_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
              <span class="n">assignment_name</span><span class="p">,</span> 
              <span class="s2">&quot;missing from nbgrader&quot;</span><span class="p">,</span> 
              <span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.DARKCYAN}</span><span class="s2">added to nbgrader</span><span class="si">{utils.color.END}</span><span class="s2">&quot;</span>
            <span class="p">]</span>
          <span class="p">)</span>
      <span class="k">if</span> <span class="n">assignments_withdrawn_from_config</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">assignment_name</span> <span class="ow">in</span> <span class="n">assignments_withdrawn_from_config</span><span class="p">:</span>
          <span class="n">gradebook</span><span class="o">.</span><span class="n">remove_assignment</span><span class="p">(</span><span class="n">assignment_name</span><span class="p">)</span>
          <span class="n">assignment_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
              <span class="n">assignment_name</span><span class="p">,</span>
              <span class="s2">&quot;missing from config&quot;</span><span class="p">,</span>
              <span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.YELLOW}</span><span class="s2">removed from nbgrader</span><span class="si">{utils.color.END}</span><span class="s2">&quot;</span>
            <span class="p">]</span>
          <span class="p">)</span>
      <span class="k">if</span> <span class="n">assignments_no_change</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">assignment_name</span> <span class="ow">in</span> <span class="n">assignments_no_change</span><span class="p">:</span>
          <span class="n">assignment_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
              <span class="n">assignment_name</span><span class="p">,</span> 
              <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u2713</span><span class="s1">&#39;</span><span class="p">,</span> <span class="c1"># unicode checkmark</span>
              <span class="s2">&quot;none&quot;</span>
            <span class="p">]</span>
          <span class="p">)</span>

      <span class="c1"># Finally, sort the status list</span>
      <span class="n">assignment_status</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">assignment_status</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 

      <span class="n">table</span> <span class="o">=</span> <span class="n">AsciiTable</span><span class="p">(</span><span class="n">assignment_header</span> <span class="o">+</span> <span class="n">assignment_status</span><span class="p">)</span>
      <span class="n">table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Assignments&#39;</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="c1"># Always make sure we close the gradebook connection, even if we error</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    An error occurred, closing connection to gradebook...&quot;</span><span class="p">)</span>
      <span class="n">gradebook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">raise</span> <span class="n">e</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Closing connection to gradebook...&quot;</span><span class="p">)</span>
    <span class="n">gradebook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Course.assign"><a class="viewcode-back" href="../../rudaux.html#rudaux.course.Course.assign">[docs]</a>  <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">assignments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
  <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assign assignments for a course</span>
<span class="sd">    </span>
<span class="sd">    :param assignments: The name or names of the assignments you wish to assign.</span>
<span class="sd">    :type assignments: str, List[str]</span>
<span class="sd">    :param overwrite: Whether or not you wish to overwrite preexisting directories</span>
<span class="sd">    :type overwrite: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># PRINT BANNER</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Creating Student Assignments&#39;</span><span class="p">))</span>

    <span class="c1"># Make sure we&#39;ve got assignments to assign</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">assignments</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No assignment in particular specified, assigning all assignments...&quot;</span><span class="p">)</span>
      <span class="n">assignments_to_assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span>
    <span class="c1"># otherwise, match the assignment(s) provided to the one in our config file</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># if just one assignment was specified...</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># find the assignments which match that name</span>
        <span class="n">assignments_to_assign</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">assn</span><span class="p">:</span> <span class="n">assn</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">assignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">))</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">assignments_to_assign</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
          <span class="n">match</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">assn</span><span class="p">:</span> <span class="n">assn</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">assignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">))</span>
          <span class="n">assignments_to_assign</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span> 
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Invalid argument supplied to `assign()`. Please specify a string or list of strings to assign.&#39;</span><span class="p">)</span>

    <span class="c1"># First things first, make the temporary student directory. No need to clone</span>
    <span class="c1"># the instructors&#39; dir since we&#39;re working in that already, and when we</span>
    <span class="c1"># initialize the course we do a git pull to make sure we have the latest</span>
    <span class="c1"># copy. </span>
    <span class="n">stu_repo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s1">&#39;students&#39;</span><span class="p">)</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#                Clone Repo             #</span>
    <span class="c1">#=======================================#</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">utils</span><span class="o">.</span><span class="n">clone_repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stu_repo_url</span><span class="p">,</span> <span class="n">stu_repo_dir</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There was an error cloning your student repository&quot;</span><span class="p">)</span>
      <span class="k">raise</span> <span class="n">e</span>

    <span class="c1">#=======================================#</span>
    <span class="c1">#          Make Student Version         #</span>
    <span class="c1">#=======================================#</span>

    <span class="c1"># set up array to save assigned assignment names in. This will be so we can</span>
    <span class="c1"># record which assignments were assigned in the commit message. </span>
    <span class="n">assignment_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">### FOR LOOP - ASSIGN ASSIGNMENTS ###</span>

    <span class="c1"># For each assignment, assign!!</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating student versions of assignments with nbgrader...&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">assignments_to_assign</span><span class="p">):</span> 

      <span class="c1"># Push the name to our names array for adding to the commit message.</span>
      <span class="n">assignment_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="c1"># assign the given assignment!</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_api</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;assigning </span><span class="si">{assignment.name}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">))</span>


    <span class="c1">### END LOOP ###</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying student versions to your student repository...&#39;</span><span class="p">)</span>

    <span class="c1"># set up directories to copy the assigned assignments to</span>
    <span class="n">generated_assignment_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">)</span>
    <span class="n">student_assignment_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stu_repo_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_release_path</span><span class="p">)</span>

    <span class="c1">#========================================#</span>
    <span class="c1">#   Move Assignments to Students Repo    #</span>
    <span class="c1">#========================================#</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">student_assignment_dir</span><span class="p">):</span>
      <span class="n">utils</span><span class="o">.</span><span class="n">safely_delete</span><span class="p">(</span><span class="n">student_assignment_dir</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

    <span class="c1"># Finally, copy to the directory, as we&#39;ve removed any preexisting ones or</span>
    <span class="c1"># exited if we didn&#39;t want to</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">generated_assignment_dir</span><span class="p">,</span> <span class="n">student_assignment_dir</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Committing changes in your instructor and student repositories...&#39;</span><span class="p">)</span>

    <span class="c1">#===========================================#</span>
    <span class="c1"># Commit &amp; Push Changes to Instructors Repo #</span>
    <span class="c1">#===========================================#</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">commit_repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Assigning {&#39; &#39;.join(assignment_names)}&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">push_repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>

    <span class="c1">#========================================#</span>
    <span class="c1"># Commit &amp; Push Changes to Students Repo #</span>
    <span class="c1">#========================================#</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">commit_repo</span><span class="p">(</span><span class="n">stu_repo_dir</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Assigning {&#39; &#39;.join(assignment_names)}&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">push_repo</span><span class="p">(</span><span class="n">stu_repo_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span></div>

  <span class="c1"># def get_assignments_from_csv(self, path: str):</span>
  <span class="c1">#   &quot;&quot;&quot;</span>
  <span class="c1">#   Bring in assignments from a CSV file. </span>
  <span class="c1">#   CSV file should contain the following columns: </span>
    
  <span class="c1">#   [required]</span>
  <span class="c1">#   - name (str): the name of the assignment</span>
  <span class="c1">#   - duedate (str): due date for the assignment</span>
  <span class="c1">#   - notebook_path (str): github URL at which the jupyter notebook lives</span>
  <span class="c1">#   - points_possible (int): the number of possible points</span>

  <span class="c1">#   [optional]</span>
  <span class="c1">#   - published (bool): whether the assignment should be published</span>
  <span class="c1">#   - description (str): a description of the assignment</span>
  <span class="c1">#   - unlock_at (str): a date at which the assignment becomes available</span>
  <span class="c1">#   - lock_at (str): date after the due date to which students can submit their assignment for partial credit</span>

  <span class="c1">#   :param path: Path to the CSV file. </span>
  <span class="c1">#   &quot;&quot;&quot;</span>
  <span class="c1">#   assignments = pd.read_csv(path)</span>
  <span class="c1">#   print(assignments)</span>

<div class="viewcode-block" id="Course.create_canvas_assignments"><a class="viewcode-back" href="../../rudaux.html#rudaux.course.Course.create_canvas_assignments">[docs]</a>  <span class="k">def</span> <span class="nf">create_canvas_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create assignments for a course.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># PRINT BANNER</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Creating/updating assignments in Canvas&#39;</span><span class="p">))</span>

    <span class="c1"># Initialize status table that we can push to as we go</span>
    <span class="n">assignment_header</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">[</span><span class="s1">&#39;Assignment&#39;</span><span class="p">,</span> <span class="s1">&#39;Action&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">assignment_status</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">update_or_create_canvas_assignment</span><span class="p">()</span>
      <span class="n">assignment_status</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">])</span>

    <span class="c1"># Sort statuses</span>
    <span class="n">assignment_status</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">assignment_status</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 

    <span class="c1">## Print status for reporting:</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">AsciiTable</span><span class="p">(</span><span class="n">assignment_header</span> <span class="o">+</span> <span class="n">assignment_status</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Assignments&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Course.schedule_grading"><a class="viewcode-back" href="../../rudaux.html#rudaux.course.Course.schedule_grading">[docs]</a>  <span class="k">def</span> <span class="nf">schedule_grading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Schedule assignment grading tasks in crontab. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># PRINT BANNER</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Scheduling Autograding&#39;</span><span class="p">))</span>

    <span class="c1"># It would probably make more sense to use `at` instead of `cron` except that:</span>
    <span class="c1"># 1. CentOS has `cron` by default, but not `at`</span>
    <span class="c1"># 2. The python CronTab module exists to make this process quite easy.</span>

    <span class="n">scheduling_status</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">[</span><span class="s1">&#39;Assignment&#39;</span><span class="p">,</span> <span class="s1">&#39;Due Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Action&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="c1"># If there is no &#39;lock at&#39; time, then the due date is the time to grade.</span>
    <span class="c1"># Otherwise, grade at the &#39;lock at&#39; time. This is to allow partial credit</span>
    <span class="c1"># for late assignments.</span>
    <span class="c1"># Reference: https://community.canvaslms.com/docs/DOC-10327-415273044</span>

    <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">schedule_grading</span><span class="p">()</span>
      <span class="n">scheduling_status</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
        <span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;close_time&#39;</span><span class="p">),</span>
        <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
      <span class="p">])</span>

    <span class="c1">## Print status for reporting:</span>
    <span class="n">status_table</span> <span class="o">=</span> <span class="n">AsciiTable</span><span class="p">(</span><span class="n">scheduling_status</span><span class="p">)</span>
    <span class="n">status_table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Grading Scheduling&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">status_table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


  <span class="c1"># def _get_course(self):</span>
  <span class="c1">#   &quot;&quot;&quot;</span>
  <span class="c1">#   Get the basic course information from Canvas</span>
  <span class="c1">#   &quot;&quot;&quot;</span>
  <span class="c1">#   resp = requests.get(</span>
  <span class="c1">#     url=f&quot;{self.canvas_url}/api/v1/courses/{self.course_id}&quot;,</span>
  <span class="c1">#     headers={</span>
  <span class="c1">#       &quot;Authorization&quot;: f&quot;Bearer {self.canvas_token}&quot;,</span>
  <span class="c1">#       &quot;Accept&quot;: &quot;application/json+canvas-string-ids&quot;</span>
  <span class="c1">#     }</span>
  <span class="c1">#   )</span>

  <span class="c1">#   # Make sure our request didn&#39;t fail silently</span>
  <span class="c1">#   resp.raise_for_status()</span>
    
  <span class="c1">#   # pull out the response JSON</span>
  <span class="c1">#   course = resp.json()</span>
  <span class="c1">#   return course</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Rudaux</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Sam Hinshaw.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>