
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>rudaux.assignment &#8212; Rudaux  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for rudaux.assignment</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">nbgrader</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pendulum</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span> <span class="k">as</span> <span class="nn">urlparse</span>

<span class="kn">from</span> <span class="nn">terminaltables</span> <span class="k">import</span> <span class="n">AsciiTable</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="k">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">weir</span> <span class="k">import</span> <span class="n">zfs</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">nbgrader.apps</span> <span class="k">import</span> <span class="n">NbGraderAPI</span>
<span class="kn">from</span> <span class="nn">nbgrader</span> <span class="k">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">nbutils</span>
<span class="c1"># This is not working properly for some reason</span>
<span class="c1"># from nbgrader.converters.base import NbGraderException</span>

<span class="kn">from</span> <span class="nn">traitlets.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">traitlets.config.application</span> <span class="k">import</span> <span class="n">Application</span>

<span class="c1"># Import my own utility functions from this module</span>
<span class="kn">import</span> <span class="nn">rudaux</span>
<span class="kn">from</span> <span class="nn">rudaux</span> <span class="k">import</span> <span class="n">utils</span>

<span class="c1"># from course import Course</span>


<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Assignment object for maniuplating assignments. </span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">course</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">duedate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">duetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">points</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">manual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">course</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unassigned&#39;</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assignment object for manipulating Assignments.</span>

<span class="sd">    :param name: The name of the assignment.</span>
<span class="sd">    :type name: str</span>
<span class="sd">    :param duedate: The assignment&#39;s due date. (default: None)</span>
<span class="sd">    :type duedate: str</span>
<span class="sd">    :param duedate: The assignment&#39;s due time. (default: None)</span>
<span class="sd">    :type duedate: str</span>
<span class="sd">    :param points: The number of points the assignment is worth. (default: 1)</span>
<span class="sd">    :type points: int</span>
<span class="sd">    :param manual: Is manual grading required? (default: False)</span>
<span class="sd">    :type manual: bool</span>
<span class="sd">    :param course: The course the assignment belongs to.</span>
<span class="sd">    :type course: Course</span>

<span class="sd">    :param status: The status of the assignment. Options: [&#39;unassigned&#39;, &#39;assigned&#39;, &#39;collected&#39;, &#39;graded&#39;, &#39;returned&#39;]</span>
<span class="sd">    :type status: str</span>

<span class="sd">    :returns: An assignment object for performing different operations on a given assignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">course</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The Assignment object must be instantiated with a course </span>
<span class="sd">        or subclassed with a course class attribute. </span>

<span class="sd">        Subclass method:</span>
<span class="sd">        ```</span>
<span class="sd">        class DSCI100Assignment(Assignment):</span>
<span class="sd">          course = dsci100</span>

<span class="sd">        homework_1 = DSCI100Assignment(</span>
<span class="sd">          name=&#39;homework_1&#39;,</span>
<span class="sd">          ...</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">        Instantiation Method:</span>
<span class="sd">        ```</span>
<span class="sd">        homework_1 = Assignment(</span>
<span class="sd">          name=&#39;homework_1&#39;,</span>
<span class="sd">          ...</span>
<span class="sd">          course=dsci100</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">        &quot;&quot;&quot;</span>
      <span class="p">)</span>

    <span class="c1"># First self assign user specified parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="o">=</span> <span class="n">manual</span>

    <span class="c1"># Only overwrite class property none present. Second check (course is not</span>
    <span class="c1"># None) is not necessary, since we should have exited by now if both were</span>
    <span class="c1"># None, but just want to be sure.</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">course</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">course</span> <span class="o">=</span> <span class="n">course</span>

    <span class="c1">#============================#</span>
    <span class="c1">#      Datetime Parsing      #</span>
    <span class="c1">#============================#</span>

    <span class="c1"># Due date is passed in from config file as a string we need to parse this</span>
    <span class="c1"># and convert it to ISO 8601 format with the course timezone. Pendulum will</span>
    <span class="c1"># handle daylight savings time for us!</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">duedate</span> <span class="o">=</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{duedate}</span><span class="s2">T</span><span class="si">{duetime}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">course_timezone</span><span class="p">)</span>
    <span class="c1"># We need to convert the course due date to the server/system due date as</span>
    <span class="c1"># well, so that our cron job will run at the correct time.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">system_due_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duedate</span><span class="o">.</span><span class="n">in_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">system_timezone</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">launch_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_launch_url</span><span class="p">()</span>

<div class="viewcode-block" id="Assignment.autograde"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment.autograde">[docs]</a>  <span class="k">def</span> <span class="nf">autograde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate automated grading with nbgrader.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="kc">False</span></div>

  <span class="c1"># def assign(</span>
  <span class="c1">#   self,</span>
  <span class="c1">#   tmp_dir=os.path.join(Path.home(), &#39;tmp&#39;),</span>
  <span class="c1">#   overwrite=False,</span>
  <span class="c1"># ) -&gt; &#39;None&#39;:</span>
  <span class="c1">#   &quot;&quot;&quot;</span>
  <span class="c1">#   Assign assignment to students (generate student copy from instructors</span>
  <span class="c1">#   repository and push to public repository). Only provide SSH URLs if you have</span>
  <span class="c1">#   an SSH-key within sshd on this machine. Otherwise we will use your Github</span>
  <span class="c1">#   Personal Access Token.</span>

  <span class="c1">#   :param tmp_dir: A temporary directory to clone your instructors repo to. </span>
  <span class="c1">#   The default dir is located within the users directory so as to ensure write </span>
  <span class="c1">#   permissions. </span>
  <span class="c1">#   &quot;&quot;&quot;</span>

  <span class="c1">#   self.overwrite = overwrite</span>

  <span class="c1">#   #=======================================#</span>
  <span class="c1">#   #       Set up Parameters &amp; Config      #</span>
  <span class="c1">#   #=======================================#</span>

  <span class="c1">#   # First things first, make the temporary directories</span>
  <span class="c1">#   ins_repo_dir = os.path.join(tmp_dir, &#39;instructors&#39;)</span>
  <span class="c1">#   stu_repo_dir = os.path.join(tmp_dir, &#39;students&#39;)</span>

  <span class="c1">#   #=======================================#</span>
  <span class="c1">#   #       Clone from Instructors Repo     #</span>
  <span class="c1">#   #=======================================#</span>

  <span class="c1">#   try:</span>
  <span class="c1">#     utils.clone_repo(self.course.ins_repo_url, ins_repo_dir, self.overwrite)</span>
  <span class="c1">#   except Exception as e:</span>
  <span class="c1">#     print(&quot;There was an error cloning your instructors repository&quot;)</span>
  <span class="c1">#     raise e</span>

  <span class="c1">#   #=======================================#</span>
  <span class="c1">#   #          Make Student Version         #</span>
  <span class="c1">#   #=======================================#</span>

  <span class="c1">#   # Make sure we&#39;re running our nbgrader commands within our instructors repo.</span>
  <span class="c1">#   # this will contain our gradebook database, our source directory, and other</span>
  <span class="c1">#   # things.</span>
  <span class="c1">#   custom_config = Config()</span>
  <span class="c1">#   custom_config.CourseDirectory.root = ins_repo_dir</span>

  <span class="c1">#   # use the traitlets Application class directly to load nbgrader config file.</span>
  <span class="c1">#   # reference:</span>
  <span class="c1">#   # https://github.com/jupyter/nbgrader/blob/41f52873c690af716c796a6003d861e493d45fea/nbgrader/server_extensions/validate_assignment/handlers.py#L35-L37</span>
  <span class="c1">#   for config in Application._load_config_files(&#39;nbgrader_config&#39;, path=ins_repo_dir):</span>
  <span class="c1">#     # merge it with our custom config</span>
  <span class="c1">#     custom_config.merge(config)</span>

  <span class="c1">#   # set up the nbgrader api with our merged config files</span>
  <span class="c1">#   nb_api = NbGraderAPI(config=custom_config)</span>

  <span class="c1">#   # assign the given assignment!</span>
  <span class="c1">#   nb_api.assign(self.name)</span>

  <span class="c1">#   generated_assignment_dir = os.path.join(ins_repo_dir, &#39;release&#39;, self.name)</span>
  <span class="c1">#   student_assignment_dir = os.path.join(stu_repo_dir, self.name)</span>
  <span class="c1">#   # make sure we assigned properly</span>
  <span class="c1">#   if not os.path.exists(generated_assignment_dir):</span>
  <span class="c1">#     sys.exit(</span>
  <span class="c1">#       f&quot;nbgrader failed to assign {self.name}, please make sure your directory structure is set up properly in nbgrader&quot;</span>
  <span class="c1">#     )</span>

  <span class="c1">#   #=======================================#</span>
  <span class="c1">#   #   Move Assignment to Students Repo    #</span>
  <span class="c1">#   #=======================================#</span>

  <span class="c1">#   try:</span>
  <span class="c1">#     utils.clone_repo(self.course.stu_repo_url, stu_repo_dir, self.overwrite)</span>
  <span class="c1">#   except Exception as e:</span>
  <span class="c1">#     print(&quot;There was an error cloning your students repository&quot;)</span>
  <span class="c1">#     raise e</span>

  <span class="c1">#   utils.safely_delete(student_assignment_dir, self.overwrite)</span>

  <span class="c1">#   # Finally, copy to the directory, as we&#39;ve removed any preexisting ones or</span>
  <span class="c1">#   # exited if we didn&#39;t want to.</span>
  <span class="c1">#   # shutil.shutil.copytree doesn&#39;t need the directory to exist beforehand</span>
  <span class="c1">#   shutil.copytree(generated_assignment_dir, student_assignment_dir)</span>

  <span class="c1">#   #=======================================#</span>
  <span class="c1">#   #      Push Changes to Students Repo    #</span>
  <span class="c1">#   #=======================================#</span>

  <span class="c1">#   utils.push_repo(stu_repo_dir)</span>

  <span class="c1">#   #=======================================#</span>
  <span class="c1">#   #        Update Assignment Status       #</span>
  <span class="c1">#   #=======================================#</span>

  <span class="c1">#   self.status = &#39;assigned&#39;</span>

  <span class="c1">#   return None</span>

  <span class="k">def</span> <span class="nf">_generate_launch_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate assignment links for assigned assignments. </span>

<span class="sd">    This will search your instructors repository for the source assignment and</span>
<span class="sd">    then generate the link to the student copy of the assignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Given an assignment name, look in that assignment&#39;s folder and pull out</span>
    <span class="c1"># the notebook path. </span>
    <span class="c1">#! Blindly take the first result!</span>
    <span class="n">notebook</span> <span class="o">=</span> <span class="n">nbutils</span><span class="o">.</span><span class="n">find_all_notebooks</span><span class="p">(</span>
      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Construct launch url for nbgitpuller</span>
    <span class="c1"># First join our hub url, hub prefix, and launch url</span>
    <span class="n">launch_url</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.course.hub_url}{self.course.hub_prefix}</span><span class="s2">/hub/lti/launch&quot;</span>
    <span class="c1"># Then construct our nbgitpuller custom next parameter</span>
    <span class="n">gitpuller_url</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.course.hub_prefix}</span><span class="s2">/hub/user-redirect/git-pull&quot;</span>
    <span class="c1"># Finally, urlencode our repository and add that</span>
    <span class="n">repo_encoded_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">stu_launch_url</span><span class="p">)</span>

    <span class="c1"># Finally glue this all together!! Now we just need to add the subpath for each assignment</span>
    <span class="n">launch_url_without_subpath</span> <span class="o">=</span> <span class="n">fr</span><span class="s2">&quot;</span><span class="si">{launch_url}</span><span class="s2">?custom_next=</span><span class="si">{gitpuller_url}%3F</span><span class="s2">repo%3D</span><span class="si">{repo_encoded_url}%26s</span><span class="s2">ubPath%3D&quot;</span>

    <span class="c1"># urlencode the assignment&#39;s subpath</span>
    <span class="n">subpath</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.course.assignment_release_path}</span><span class="s2">/</span><span class="si">{notebook}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># and join it to the previously constructed launch URL (hub + nbgitpuller language)</span>
    <span class="n">full_launch_url</span> <span class="o">=</span> <span class="n">launch_url_without_subpath</span> <span class="o">+</span> <span class="n">subpath</span>

    <span class="k">return</span> <span class="n">full_launch_url</span>

  <span class="k">def</span> <span class="nf">_search_canvas_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Dict[str, str]&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find a Canvas assignment by its name.</span>
<span class="sd">    </span>
<span class="sd">    :param name: The name of the canvas assignment</span>
<span class="sd">    :type name: str</span>
<span class="sd">    :return: The canvas assignment object</span>
<span class="sd">    :rtype: Dict[str, str]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
      <span class="n">url</span><span class="o">=</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">canvas_url</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;/api/v1/courses/</span><span class="si">{self.course.course_id}</span><span class="s2">/assignments&quot;</span>
      <span class="p">),</span>
      <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;Bearer </span><span class="si">{self.course.canvas_token}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json+canvas-string-ids&quot;</span>
      <span class="p">},</span>
      <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;search_term&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Check to see if we found an assignment with this name</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">first_result</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
      <span class="c1"># If we found more than one, let the user know</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
          <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          Found more than one assignment, using first result, &quot;{first_result.get(&#39;name&#39;)}&quot;.</span>
<span class="s2">          &quot;&quot;&quot;</span>
        <span class="p">)</span>
      <span class="c1"># But regardless, use the first result found</span>
      <span class="c1"># Also assign to self</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="o">=</span> <span class="n">first_result</span>
      <span class="k">return</span> <span class="n">first_result</span>

    <span class="k">else</span><span class="p">:</span> 
      <span class="k">return</span> <span class="kc">None</span>

    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_create_canvas_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create an assignment in Canvas.</span>
<span class="sd">    </span>
<span class="sd">    :param name: The name of the assignment</span>
<span class="sd">    :type name: str</span>
<span class="sd">    :return: None: called for side-effects.</span>
<span class="sd">    :rtype: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
      <span class="n">url</span><span class="o">=</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">canvas_url</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;/api/v1/courses/</span><span class="si">{self.course.course_id}</span><span class="s2">/assignments&quot;</span>
      <span class="p">),</span>
      <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;Bearer </span><span class="si">{self.course.canvas_token}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json+canvas-string-ids&quot;</span>
      <span class="p">},</span>
      <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
          <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">duedate</span><span class="o">.</span><span class="n">to_iso8601_string</span><span class="p">(),</span>
          <span class="s2">&quot;points_possible&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span>
          <span class="s2">&quot;submission_types&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;external_tool&#39;</span><span class="p">],</span>
          <span class="s2">&quot;external_tool_tag_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_url</span><span class="p">,</span>
            <span class="s2">&quot;new_tab&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;content_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">external_tool_id</span><span class="p">,</span>
            <span class="s2">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;context_external_tool&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_update_canvas_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update an assignment.</span>

<span class="sd">    :param assignment_id: The numeric ID of the assignment in Canvas</span>
<span class="sd">    :type assignment_id: int</span>
<span class="sd">    :return: No return, called for side-effects.</span>
<span class="sd">    :rtype: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
      <span class="n">url</span><span class="o">=</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">canvas_url</span><span class="p">,</span>
        <span class="n">f</span><span class="s2">&quot;/api/v1/courses/</span><span class="si">{self.course.course_id}</span><span class="s2">/assignments/</span><span class="si">{assignment_id}</span><span class="s2">&quot;</span>
      <span class="p">),</span>
      <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;Bearer </span><span class="si">{self.course.canvas_token}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json+canvas-string-ids&quot;</span>
      <span class="p">},</span>
      <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;assignment&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;due_at&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">duedate</span><span class="o">.</span><span class="n">to_iso8601_string</span><span class="p">(),</span>
          <span class="s2">&quot;points_possible&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span>
          <span class="s2">&quot;submission_types&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;external_tool&#39;</span><span class="p">],</span>
          <span class="s2">&quot;external_tool_tag_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_url</span><span class="p">,</span>
            <span class="s2">&quot;new_tab&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;content_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">external_tool_id</span><span class="p">,</span>
            <span class="s2">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;context_external_tool&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Make sure our request didn&#39;t fail silently</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<div class="viewcode-block" id="Assignment.update_or_create_canvas_assignment"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment.update_or_create_canvas_assignment">[docs]</a>  <span class="k">def</span> <span class="nf">update_or_create_canvas_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Update or create an assignment, depending on whether or not it was found</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_canvas_assignment</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_canvas_assignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.PURPLE}</span><span class="s1">updated</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_canvas_assignment</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.DARKCYAN}</span><span class="s1">created</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span></div>

<div class="viewcode-block" id="Assignment.schedule_grading"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment.schedule_grading">[docs]</a>  <span class="k">def</span> <span class="nf">schedule_grading</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Assignment&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Schedule grading of an assignment.</span>
<span class="sd">    </span>
<span class="sd">    :param cron: Crontab of your server</span>
<span class="sd">    :type cron: Cron</span>
<span class="sd">    :return: self</span>
<span class="sd">    :rtype: Assignment</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize dict for status reporting</span>
    <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initialize an empty value for close_time</span>
    <span class="n">close_time</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># =================================== #</span>
    <span class="c1">#     Find Due Date (Close Time)      #</span>
    <span class="c1"># =================================== #</span>

    <span class="c1"># NOTE: Because we are SCHEDULING our grading for the server here, </span>
    <span class="c1"># we need to use the system time, not the course time.</span>

    <span class="c1"># if both of those came back as none, or we haven&#39;t hit the </span>
    <span class="c1"># Canvas API, use our own due date, as determined when the </span>
    <span class="c1"># Assignment was instantiated (with the from the date from</span>
    <span class="c1"># the config object)</span>

    <span class="c1"># Use system due date before checking for canvas_assignment.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_due_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">close_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_due_date</span>

    <span class="c1"># If we found the assignment in Canvas, we can look for a lock date.</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;canvas_assignment&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lock_at&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Canvas uses UTC</span>
        <span class="n">close_time</span> <span class="o">=</span> <span class="n">pendulum</span> \
          <span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lock_at&#39;</span><span class="p">),</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span> \
          <span class="o">.</span><span class="n">in_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">system_timezone</span><span class="p">)</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Canvas uses UTC</span>
        <span class="n">close_time</span> <span class="o">=</span> <span class="n">pendulum</span> \
          <span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_at&#39;</span><span class="p">),</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span> \
          <span class="o">.</span><span class="n">in_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">system_timezone</span><span class="p">)</span>

    <span class="c1"># If we STILL haven&#39;t found a due date by now, skip scheduling grading!!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">close_time</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span>
        <span class="n">f</span><span class="s1">&#39;Could not find a due date or lock date for </span><span class="si">{self.name}</span><span class="s1">, automatic grading will not be scheduled.&#39;</span>
      <span class="p">)</span>
      <span class="n">status</span><span class="p">[</span><span class="s1">&#39;close_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
      <span class="n">status</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
      
      <span class="c1"># Exit early if no due date found!</span>
      <span class="k">return</span> <span class="n">status</span>

    <span class="c1"># ============================================== #</span>
    <span class="c1">#     Done looking for due date (close time)     #</span>
    <span class="c1"># ============================================== #</span>

    <span class="c1"># pretty print the due date/close_time in the course timezone</span>
    <span class="n">close_time_course_time</span> <span class="o">=</span> <span class="n">close_time</span>   \
      <span class="o">.</span><span class="n">in_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">course_timezone</span><span class="p">)</span>

    <span class="n">status</span><span class="p">[</span><span class="s1">&#39;close_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">close_time_course_time</span><span class="o">.</span><span class="n">to_day_datetime_string</span><span class="p">()</span>

    <span class="c1"># Could potentially fall back to closing at course end date, but doesn&#39;t seem particularly helpful</span>
    <span class="c1"># elif self.course.get(&#39;end_at&#39;) is not None:</span>
    <span class="c1">#   close_time = parse(self.course[&#39;end_at&#39;])</span>

    <span class="c1"># Make sure we don&#39;t have a job for this already, and then set it if it&#39;s valid</span>

    <span class="c1"># convert generator to list so we can iterate over it multiple times</span>
    <span class="n">existing_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">cron</span><span class="o">.</span><span class="n">find_comment</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Autograde </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="c1"># Check to see if we found any preexisting jobs</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">existing_jobs</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
      <span class="n">status</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.PURPLE}</span><span class="s1">updated</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span>

      <span class="c1"># if so, delete the previously scheduled jobs before setting a new command</span>
      <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">existing_jobs</span><span class="p">:</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">cron</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

    <span class="c1"># Otherwise just go ahead and set the job</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.DARKCYAN}</span><span class="s1">created</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span>

    <span class="c1"># If we require manual grading, set the flag</span>
    <span class="n">man_graded</span> <span class="o">=</span> <span class="s1">&#39; -m&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Construct the grade command for cron to run</span>
    <span class="n">grade_command</span> <span class="o">=</span> <span class="s2">&quot;eval `ssh-agent` &amp;&amp; &quot;</span>                  <span class="o">+</span> \
      <span class="s2">&quot;ssh-add /home/jupyter/.ssh/instructors &amp;&amp; &quot;</span>          <span class="o">+</span> \
      <span class="s2">&quot;ssh-add /home/jupyter/.ssh/students &amp;&amp; &quot;</span>             <span class="o">+</span> \
      <span class="n">f</span><span class="s2">&quot;bash -l -c </span><span class="se">\&quot;</span><span class="s2">&quot;</span>                                      <span class="o">+</span> \
      <span class="n">f</span><span class="s2">&quot;rudaux grade &#39;</span><span class="si">{self.name}</span><span class="s2">&#39; --cron &quot;</span>                 <span class="o">+</span> \
      <span class="n">f</span><span class="s2">&quot;--dir </span><span class="si">{self.course.working_directory}{man_graded}</span><span class="s2"> &quot;</span> <span class="o">+</span> \
      <span class="n">f</span><span class="s2">&quot;&gt;&gt; </span><span class="si">{self.course.working_directory}</span><span class="s2">&quot;</span>                 <span class="o">+</span> \
      <span class="n">f</span><span class="s2">&quot;/{close_time_course_time.format(&#39;YYYY-MM-DD-HHmm&#39;)}-autograde-</span><span class="si">{self.name}</span><span class="s2">.log</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
      <span class="c1"># Make sure we log the results!</span>

    <span class="c1"># Then add our new job</span>
    <span class="n">new_autograde_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">cron</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
      <span class="n">command</span><span class="o">=</span><span class="n">grade_command</span><span class="p">,</span>
      <span class="n">comment</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;Autograde </span><span class="si">{self.name}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Make sure it&#39;s valid...</span>
    <span class="k">if</span> <span class="n">new_autograde_job</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
      <span class="c1"># And set it!</span>
      <span class="n">new_autograde_job</span><span class="o">.</span><span class="n">setall</span><span class="p">(</span><span class="n">close_time</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">cron</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="n">status</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Automatic grading for </span><span class="si">{self.name}</span><span class="s1"> failed due to invalid cron job formatting:&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">new_autograde_job</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">status</span></div>

  <span class="c1"># These functions are intended only to be run from commands.grade(), </span>
  <span class="c1"># which is intended only to be run from a system-level crontab</span>
  <span class="c1"># OR with sudo permissions.</span>
  <span class="c1"># def snapshot_zfs(self):</span>
  <span class="c1">#   &quot;&quot;&quot;Snapshot the ZFS filesystem.</span>
    
  <span class="c1">#   &quot;&quot;&quot;</span>

  <span class="c1">#   # construct command for zfs.</span>
  <span class="c1">#   # ZFS refers to its &#39;datasets&#39; without a preceding slash</span>
  <span class="c1">#   dataset = re.sub(&#39;^/&#39;, &#39;&#39;, self.course.storage_path)</span>
  <span class="c1">#   snapshot_name = f&quot;{dataset}@{self.name}&quot;</span>

  <span class="c1">#   # Now, we can use Weir to check for preexisting snapshots</span>
  <span class="c1">#   existing_snapshots = zfs.open(dataset).snapshots()</span>

  <span class="c1">#   # The whole reason we are doing this is because our snapshot names must be unique</span>
  <span class="c1">#   # So if we DO have a hit, there can only be one!</span>
  <span class="c1">#   preexisting_snapshots = list(filter(lambda snap: snap.name == snapshot_name, existing_snapshots))</span>

  <span class="c1">#   # so if we have a hit, get the date of that snap</span>
  <span class="c1">#   if len(preexisting_snapshots) &gt; 0:</span>
  <span class="c1">#     preexisting_snapshot = preexisting_snapshots[0]</span>
  <span class="c1">#     snap_date = preexisting_snapshot.getprop(&#39;creation&#39;).get(&#39;value&#39;)</span>
  <span class="c1">#     snap_time = time.strftime(r&#39;%Y-%m-%d %H:%M:%S&#39;, time.localtime(int(snap_date)))</span>
  <span class="c1">#     print(f&#39;Using preexisting snapshot for this assignment created at {snap_time} (server time).&#39;)</span>
  <span class="c1">#   else: </span>
  <span class="c1">#     # we&#39;ll name the snapshot after the assignment being graded</span>
  <span class="c1">#     #! I feel like we can&#39;t run a sudo command from the user crontab</span>
  <span class="c1">#     subprocess.run([&quot;sudo&quot;, &quot;zfs&quot;, &quot;snapshot&quot;, snapshot_name], check=True)</span>

<div class="viewcode-block" id="Assignment.collect"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment.collect">[docs]</a>  <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect an assignment via the nbgrader API.</span>
<span class="sd">    This essentially copies the notebooks to a new location</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Collecting </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">student_ids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stu</span><span class="p">:</span> <span class="n">stu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">students</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No students found. Please run `course.get_students_from_canvas()` before collecting an assignment.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">zfs</span><span class="p">:</span>
      <span class="c1"># This is the snapshot name for this assignment. This may be an hourly</span>
      <span class="c1"># snapshot that corresponds to the due date, or it might be the</span>
      <span class="c1"># assignment name.</span>
      <span class="n">snapshot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
      <span class="n">zfs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="s1">&#39;.zfs&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;snapshot&#39;</span><span class="p">,</span> 
        <span class="n">snapshot_name</span>
      <span class="p">)</span>

    <span class="n">assignment_collection_header</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">[</span><span class="s1">&#39;Student ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Collection Status&#39;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">assignment_collection_status</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># get the assignment path for each student ID in Canvas</span>
    <span class="k">for</span> <span class="n">student_id</span> <span class="ow">in</span> <span class="n">student_ids</span><span class="p">:</span>

      <span class="c1"># **CRUCIALLY IMPORTANT**</span>
      <span class="c1"># Create submission in gradebook for student.</span>
      <span class="c1"># If this is never done, then autograding doesn&#39;t</span>
      <span class="c1"># record grades in the gradebook.</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">nb_api</span><span class="o">.</span><span class="n">gradebook</span><span class="o">.</span><span class="n">add_submission</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">student_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">nb_api</span><span class="o">.</span><span class="n">gradebook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">nb_api</span><span class="o">.</span><span class="n">gradebook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">e</span>

      <span class="n">student_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">storage_path</span><span class="p">,</span>
        <span class="n">student_id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">stu_repo_name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">assignment_release_path</span>
      <span class="p">)</span>

      <span class="c1"># If zfs, use the student + zfs + assignment name path</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">zfs</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">student_path</span><span class="p">,</span> <span class="s1">&#39;.zfs&#39;</span><span class="p">)):</span>
        <span class="c1"># Check that we&#39;re using ZFS</span>
        <span class="n">assignment_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
          <span class="n">student_path</span><span class="p">,</span> 
          <span class="n">zfs_path</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
      <span class="c1"># otherwise just use the student&#39;s work directly</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">assignment_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
          <span class="n">student_path</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

      <span class="n">submission_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span> <span class="n">student_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="c1"># then copy the work into the submitted directory + student_id + assignment_name</span>

      <span class="c1"># Since we&#39;re JUST copying the current assignment, we can safely overwrite it</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">submission_path</span><span class="p">)</span>
      <span class="c1"># Doesn&#39;t matter if it doesn&#39;t exist though</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">assignment_path</span><span class="p">,</span> <span class="n">submission_path</span><span class="p">)</span>
      <span class="c1"># if no assignment for that student, fail</span>
      <span class="c1">#* NOTE: could also be due to incorrect directory structure.</span>
      <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">assignment_collection_status</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">student_id</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.RED}</span><span class="s1">failure</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span> 
        <span class="n">assignment_collection_status</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">student_id</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.GREEN}</span><span class="s1">success</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span><span class="p">])</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">AsciiTable</span><span class="p">(</span><span class="n">assignment_collection_header</span> <span class="o">+</span> <span class="n">assignment_collection_status</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Assignment Collection&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="c1"># What I just did WAS collecting the assignment.</span>
    <span class="c1"># Finally, collect the assignment</span>
    <span class="c1"># res = self.course.nb_api.collect(self.name)</span>

    <span class="c1"># if res.get(&#39;success&#39;):</span>
    <span class="c1">#   print(f&#39;Successfully collected {self.name}.&#39;)</span>
    <span class="c1"># if res.get(&#39;error&#39;) is not None:</span>
    <span class="c1">#   print(f&#39;There was an error collecting {self.name}.&#39;)</span>
    <span class="c1">#   print(res.get(&#39;error&#39;))</span>
    <span class="c1"># if res.get(&#39;log&#39;) is not None:</span>
    <span class="c1">#   print(f&#39;Log result of collecting {self.name}.&#39;)</span>
    <span class="c1">#   print(res.get(&#39;log&#39;))</span>

    <span class="c1"># Commit repo</span>
    <span class="c1"># Push Repo</span>

    <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Assignment.grade"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment.grade">[docs]</a>  <span class="k">def</span> <span class="nf">grade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Autograde an assignment via the nbgrader API.</span>
<span class="sd">    This runs `nbgrader autograde` within a docker container.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Autograding </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">res</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="s2">&quot;docker&quot;</span><span class="p">,</span>
          <span class="s2">&quot;run&quot;</span><span class="p">,</span>
          <span class="s2">&quot;--rm&quot;</span><span class="p">,</span>
          <span class="s2">&quot;-u&quot;</span><span class="p">,</span>
          <span class="s2">&quot;jupyter&quot;</span><span class="p">,</span>
          <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
          <span class="n">f</span><span class="s2">&quot;/home/jupyter/</span><span class="si">{self.course.ins_repo_name}</span><span class="s2">:/assignments/&quot;</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">grading_image</span><span class="p">,</span>
          <span class="s2">&quot;autograde&quot;</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">],</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">True</span>
      <span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.RED}</span><span class="s2">Error autograding </span><span class="si">{self.name}{utils.color.END}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.RED}</span><span class="s2">Unspecified error autograding </span><span class="si">{self.name}{utils.color.END}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.GREEN}</span><span class="s2">Successfully autograded </span><span class="si">{self.name}{utils.color.END}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#===========================================#</span>
    <span class="c1"># Commit &amp; Push Changes to Instructors Repo #</span>
    <span class="c1">#===========================================#</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">commit_repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Autograded </span><span class="si">{self.name}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">push_repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Assignment.feedback"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment.feedback">[docs]</a>  <span class="k">def</span> <span class="nf">feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate feedback reports for student assignments.  </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Generating Feedback for </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">nb_api</span><span class="o">.</span><span class="n">feedback</span><span class="p">(</span><span class="n">assignment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.RED}</span><span class="s2">Error generating feedback for </span><span class="si">{self.name}{utils.color.END}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{utils.color.GREEN}</span><span class="s2">Successfully generated feedback for </span><span class="si">{self.name}{utils.color.END}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1">#===========================================#</span>
    <span class="c1"># Commit &amp; Push Changes to Instructors Repo #</span>
    <span class="c1">#===========================================#</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">commit_repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Generated feedback for </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">push_repo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Assignment.submit"><a class="viewcode-back" href="../../rudaux.html#rudaux.assignment.Assignment.submit">[docs]</a>  <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload grades to Canvas.  </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Print banner</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Submitting </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="c1"># Check that we have the canvas_assignment containing the assignment_id</span>
    <span class="c1"># ...and if we don&#39;t, get it!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;canvas_assignment&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_canvas_assignment</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_canvas_assignment</span><span class="p">()</span>

    <span class="c1"># Pull out the assignment ID</span>
    <span class="n">assignment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_assignment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

    <span class="c1"># get the student IDs</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">student_ids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stu</span><span class="p">:</span> <span class="n">stu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">students</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No students found. Please run `course.get_students_from_canvas()` before collecting an assignment.&quot;</span><span class="p">)</span>

    <span class="n">grades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_grades</span><span class="p">(</span><span class="n">student_ids</span><span class="p">)</span>

    <span class="c1"># Set up status reporting</span>
    <span class="n">submission_header</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">[</span><span class="s1">&#39;Student ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Collection Status&#39;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">submission_status</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># for each student</span>
    <span class="k">for</span> <span class="n">grade</span> <span class="ow">in</span> <span class="n">grades</span><span class="p">:</span>
      <span class="c1"># upload their grade</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">canvas_url</span><span class="p">,</span> 
          <span class="n">f</span><span class="s2">&quot;/api/v1/courses/</span><span class="si">{self.course.course_id}</span><span class="s2">/assignments/</span><span class="si">{assignment_id}</span><span class="s2">/submissions/{grade.get(&#39;student_id&#39;)}&quot;</span>
        <span class="p">),</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
          <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;Bearer </span><span class="si">{self.course.canvas_token}</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json+canvas-string-ids&quot;</span>
        <span class="p">},</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
          <span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;posted_grade&quot;</span><span class="p">:</span> <span class="n">grade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">)</span>

      <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">submission_status</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">grade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;student_id&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.GREEN}</span><span class="s1">success</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">submission_status</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">grade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;student_id&#39;</span><span class="p">),</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{utils.color.RED}</span><span class="s1">failure</span><span class="si">{utils.color.END}</span><span class="s1">&#39;</span><span class="p">])</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">AsciiTable</span><span class="p">(</span><span class="n">submission_header</span> <span class="o">+</span> <span class="n">submission_status</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Assignment Submission&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span></div>


  <span class="k">def</span> <span class="nf">_get_grades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Get the grade of an assignment for a list of students.</span>
<span class="sd">    </span>
<span class="sd">    :param student_ids: A list of your student IDs as strs or ints.</span>
<span class="sd">    :type student_ids: List[Union[str, int]]</span>
<span class="sd">    :return: A dictionary with each student&#39;s grade for the assignment.</span>
<span class="sd">    :rtype: Dict[str, Union[str, int]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">gradebook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">nb_api</span><span class="o">.</span><span class="n">gradebook</span>

    <span class="n">grades</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># wrap gradebook commands in a try/except to properly close gradebook</span>
    <span class="c1"># connection if an error occurs</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># get gradebook&#39;s copy of the assignment</span>
      <span class="n">assignment</span> <span class="o">=</span> <span class="n">gradebook</span><span class="o">.</span><span class="n">find_assignment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="c1"># find grade for each student</span>
      <span class="c1"># Loop over each student in the database</span>
      <span class="k">for</span> <span class="n">student_id</span> <span class="ow">in</span> <span class="n">student_ids</span><span class="p">:</span>
        <span class="c1"># Create a dictionary that will store information about this</span>
        <span class="c1"># student&#39;s submitted assignment</span>

        <span class="n">score</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s1">&#39;student_id&#39;</span><span class="p">:</span> <span class="n">student_id</span><span class="p">,</span>
          <span class="s1">&#39;max_score&#39;</span><span class="p">:</span> <span class="n">assignment</span><span class="o">.</span><span class="n">max_score</span>
        <span class="p">}</span>

        <span class="c1"># Try to find the submission in the database. If it doesn&#39;t</span>
        <span class="c1"># exist, the `MissingEntry` exception will be raised, which</span>
        <span class="c1"># means the student didn&#39;t submit anything, so we assign them a</span>
        <span class="c1"># score of zero.</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">submission</span> <span class="o">=</span> <span class="n">gradebook</span><span class="o">.</span><span class="n">find_submission</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">student_id</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">nbgrader</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">MissingEntry</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No submission found for </span><span class="si">{student_id}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;raw_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;late_submission_penalty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">penalty</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">late_submission_penalty</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">timestamp</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;raw_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">score</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;late_submission_penalty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">penalty</span>
          <span class="n">score</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">score</span> <span class="o">-</span> <span class="n">penalty</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">score</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">score</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">score</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">grades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="c1"># unless we reach an error...</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="c1"># Then close the connection</span>
      <span class="n">gradebook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="c1"># and raise the exception</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># otherwise</span>
      <span class="n">gradebook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">grades</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Rudaux</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Sam Hinshaw.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>